<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.solsol.heycalendar.mapper.UserMapper">

    <!-- ê³µí†µ ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸ -->
    <sql id="User_Columns">
        `userNm`,
        `userMileage`,
        `accountNm`,
        `userId`,
        `password`,
        `userKey`,
        `userName`,
        `state`,
        `grade`,
        `gpa`,
        `createdAt`,
        `updatedAt`,
        UPPER(`role`) AS `role`,
        `deptNm`,
        `collegeNm`,
        `univNm`
    </sql>

    <!-- ResultMap: ENUMê³¼ LocalDateTime ìžë™ ë§¤í•‘(ê¸°ë³¸ TypeHandler ì‚¬ìš©) -->
    <resultMap id="UserResultMap" type="com.solsol.heycalendar.domain.User">
        <id     property="userNm"      column="userNm"/>
        <result property="userMileage" column="userMileage"/>
        <result property="accountNm"   column="accountNm"/>
        <result property="userId"      column="userId"/>
        <result property="password"    column="password"/>
        <result property="userKey"     column="userKey"/>
        <result property="userName"    column="userName"/>
        <result property="state"      column="state"    javaType="com.solsol.heycalendar.domain.State"/>
        <result property="grade"       column="grade"/>
        <result property="gpa"         column="gpa"      javaType="java.math.BigDecimal"/>
        <result property="createdAt"   column="createdAt" javaType="java.time.LocalDateTime"/>
        <result property="updatedAt"   column="updatedAt" javaType="java.time.LocalDateTime"/>
        <result property="role"        column="role"     javaType="com.solsol.heycalendar.domain.Role"/>
        <result property="deptNm"      column="deptNm"/>
        <result property="collegeNm"   column="collegeNm"/>
        <result property="univNm"      column="univNm"/>
    </resultMap>

    <!-- userIdë¡œ ë‹¨ê±´ ì¡°íšŒ -->
    <select id="findByUserId" parameterType="string" resultMap="UserResultMap">
        SELECT
        <include refid="User_Columns"/>
        FROM `users`
        WHERE `userId` = #{userId}
        LIMIT 1
    </select>

    <!-- userNm(í•™ë²ˆ)ë¡œ ë‹¨ê±´ ì¡°íšŒ -->
    <select id="findByUserNm" parameterType="string" resultMap="UserResultMap">
        SELECT
        <include refid="User_Columns"/>
        FROM `users`
        WHERE `userNm` = #{userNm}
        LIMIT 1
    </select>

    <!-- ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ìˆ˜ì • -->
    <update id="updatePasswordByUserId">
        UPDATE `users`
        SET
            `password` = #{encodedPassword},
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userId` = #{userId}
    </update>

    <!-- ë¹„ë°€ë²ˆí˜¸ ìž¬ì„¤ì •ìš© ì½”ë“œ ì €ìž¥ -->
    <update id="updateUserKeyByUserId">
        UPDATE `users`
        SET
            `userKey` = #{userKey},
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userId` = #{userId}
    </update>

    <!-- ë¹„ë°€ë²ˆí˜¸ ìž¬ì„¤ì • ì™„ë£Œ í›„ ì½”ë“œ ì œê±° -->
    <update id="clearUserKeyByUserId">
        UPDATE `users`
        SET
            `userKey` = NULL,
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userId` = #{userId}
    </update>

    <!-- ðŸ”¹ userKeyë¡œ ë‹¨ê±´ ì¡°íšŒ -->
    <select id="findByUserKey" parameterType="string" resultMap="UserResultMap">
        SELECT
        <include refid="User_Columns"/>
        FROM `users`
        WHERE `userKey` = #{userKey}
        LIMIT 1
    </select>

    <!-- ðŸ”¹ userKeyë¡œ í† í° ì œê±° -->
    <update id="clearUserKeyByUserKey">
        UPDATE `users`
        SET
            `userKey` = NULL,
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userKey` = #{userKey}
    </update>

    <!-- ðŸ”¹ ì‹ í•œì€í–‰ ìœ ì €í‚¤ì™€ ê³„ì¢Œë²ˆí˜¸ ì €ìž¥ -->
    <update id="updateUserKeyAndAccountByUserId">
        UPDATE `users`
        SET
            `userKey` = #{userKey},
            `accountNm` = #{accountNm},
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userId` = #{userId}
    </update>

    <!-- ðŸ”¹ ì‚¬ìš©ìž ì •ë³´ ìˆ˜ì • -->
    <update id="updateUserInfo">
        UPDATE `users`
        SET
            `updatedAt` = CURRENT_TIMESTAMP
            <if test="request.userName != null and request.userName != ''">
                , `userName` = #{request.userName}
            </if>
            <if test="request.deptNm != null">
                , `deptNm` = #{request.deptNm}
            </if>
            <if test="request.collegeNm != null">
                , `collegeNm` = #{request.collegeNm}
            </if>
            <if test="request.univNm != null">
                , `univNm` = #{request.univNm}
            </if>
            <if test="request.grade != null">
                , `grade` = #{request.grade}
            </if>
        WHERE `userId` = #{userId}
    </update>

    <!-- ðŸ”¹ íšŒì›ê°€ìž… ì‹œ ì‚¬ìš©ìž ë“±ë¡ -->
    <insert id="insertUser" parameterType="com.solsol.heycalendar.domain.User">
        INSERT INTO `users` (
            `userNm`,
            `userId`,
            `password`,
            `userName`,
            `state`,
            `grade`,
            `deptNm`,
            `collegeNm`,
            `univNm`,
            `role`,
            `createdAt`,
            `updatedAt`
        ) VALUES (
            #{userNm},
            #{userId},
            #{password},
            #{userName},
            #{state},
            #{grade},
            #{deptNm},
            #{collegeNm},
            #{univNm},
            #{role},
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP
        )
    </insert>

    <!-- í™œì„± ì‚¬ìš©ìžì˜ userNm ëª©ë¡ ì¡°íšŒ (ì•Œë¦¼ìš©) -->
    <select id="findAllActiveUserNames" resultType="string">
        SELECT userNm 
        FROM `users`
        WHERE state = 'ENROLLED'
    </select>

    <!-- ë§ˆì¼ë¦¬ì§€ ì ˆëŒ€ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸ -->
    <update id="updateUserMileage">
        UPDATE `users`
        SET 
            `userMileage` = #{mileageAmount},
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userNm` = #{userNm}
    </update>

    <!-- ë§ˆì¼ë¦¬ì§€ ì¶”ê°€ (ê¸°ì¡´ ê°’ì— ë”í•˜ê¸°) -->
    <update id="addUserMileage">
        UPDATE `users`
        SET 
            `userMileage` = COALESCE(`userMileage`, 0) + #{mileageAmount},
            `updatedAt` = CURRENT_TIMESTAMP
        WHERE `userNm` = #{userNm}
    </update>

</mapper>
